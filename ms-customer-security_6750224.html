<!DOCTYPE html>
<html>
    <head>
        <title>专业剑 : ms-customer-security</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">专业剑</a></span>
                            </li>
                                                    <li>
                                <span><a href="Base-Services_6389781.html">Base Services</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            专业剑 : ms-customer-security
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> admin</span>, last modified on 四月 30, 2025
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1749908445444 {padding: 0px;}
div.rbtoc1749908445444 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1749908445444 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1749908445444'>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-服务描述'>服务描述</a></li>
<li><a href='#ms-customer-security-主要API'>主要API</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-APIGET/biometric-login指纹登录'>API GET /biometric-login 指纹登录</a></li>
<li><a href='#ms-customer-security-APIPOST/biometric-login指纹登录'>API POST /biometric-login 指纹登录</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-流程：'>流程：</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-API/biometric-login/register'>API /biometric-login/register</a></li>
<li><a href='#ms-customer-security-API/biometric-login/deregister'>API /biometric-login/deregister</a></li>
<li><a href='#ms-customer-security-API/ndi/biometric-login/{action}'>API /ndi/biometric-login/{action}</a></li>
<li><a href='#ms-customer-security-API/pre-login/parameterGET'>API /pre-login/parameter GET </a></li>
<li><a href='#ms-customer-security-API/pre-loginPOST注册/激活网上银行'>API /pre-login POST 注册/激活网上银行</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-流程'>流程</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-API/pre-login/verifyPOST'>API /pre-login/verify POST</a></li>
<li><a href='#ms-customer-security-API/accesscode-loginGET用户名登录，获取登录所需参数'>API /accesscode-login GET 用户名登录，获取登录所需参数</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-流程.1'>流程</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-API/accesscode-loginPOST用户名登录'>API /accesscode-login POST 用户名登录</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-1.校验请求信息checksecurityimage。'>1. 校验请求信息check security image。</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-1.1校验验证码Captcha'>1.1 校验验证码Captcha</a></li>
<li><a href='#ms-customer-security-1.2校验请求参数'>1.2 校验请求参数</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-2.登录流程'>2. 登录流程</a></li>
<li><a href='#ms-customer-security-流程：.1'>流程：</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-API/accesscode-login/change-passwordGETaccesscodelogin修改密码'>API /accesscode-login/change-password GET accesscode login修改密码</a></li>
<li><a href='#ms-customer-security-API/accesscode-login/change-passwordPOSTaccesscodelogin修改密码'>API /accesscode-login/change-password POST accesscode login修改密码</a></li>
<li><a href='#ms-customer-security-API/accesscode-login/changeGETaccesscodelogin修改loginID'>API /accesscode-login/change GET accesscode login修改loginID</a></li>
<li><a href='#ms-customer-security-API/accesscode-login/changePOSTaccesscodelogin修改loginID'>API /accesscode-login/change POST accesscode login修改loginID</a></li>
<li><a href='#ms-customer-security-API/accesscode-login/accesscode/changePOST修改accesscode'>API /accesscode-login/accesscode/change POST 修改accesscode</a></li>
<li><a href='#ms-customer-security-API/accesscode-elevation/elevatePOST'>API /accesscode-elevation/elevate POST</a></li>
<li><a href='#ms-customer-security-API/singpass-loginPOSTSingpass登录'>API /singpass-login POST Singpass登录</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-流程：.2'>流程：</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-API/tnc/update'>API /tnc/update</a></li>
<li><a href='#ms-customer-security-APIGET/user-info'>API GET /user-info</a></li>
<li><a href='#ms-customer-security-APIPOST/user/retrieve'>API POST /user/retrieve</a></li>
<li><a href='#ms-customer-security-API/user-management/access'>API /user-management/access</a></li>
<li><a href='#ms-customer-security-API/logout登出'>API /logout 登出</a></li>
<li><a href='#ms-customer-security-APItrouble-login/initPOST'>API trouble-login/init POST</a></li>
<li><a href='#ms-customer-security-APItrouble-login/retrievePOST'>API trouble-login/retrieve POST</a></li>
<li><a href='#ms-customer-security-APItrouble-login/submitPOST'>API trouble-login/submit POST</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-主要业务流程'>主要业务流程</a></li>
<li><a href='#ms-customer-security-主要架构设计方案'>主要架构设计方案</a></li>
<li><a href='#ms-customer-security-主要数据库设计'>主要数据库设计</a>
<ul class='toc-indentation'>
<li><a href='#ms-customer-security-usr用户表'>usr用户表</a></li>
<li><a href='#ms-customer-security-usr_auth用户登录表'>usr_auth 用户登录表</a></li>
<li><a href='#ms-customer-security-usr_reg用户注册表'>usr_reg 用户注册表</a></li>
<li><a href='#ms-customer-security-usr_authorization'>usr_authorization</a></li>
</ul>
</li>
<li><a href='#ms-customer-security-遇到的问题和解决方案'>遇到的问题和解决方案</a></li>
<li><a href='#ms-customer-security-优缺点和改进方案分析，业界对比'>优缺点和改进方案分析，业界对比</a></li>
</ul>
</div></p><h2 id="ms-customer-security-服务描述">服务描述</h2><p>负责用户登录鉴权的服务。</p><p>用户注册开卡的服务：ms-onshore-onboarding，ms-offshore-onboarding。</p><p>用户注册/激活网上银行: /pre-login。</p><p>用户登录：/access-code/login。</p><h2 id="ms-customer-security-主要API">主要API</h2><h3 id="ms-customer-security-APIGET/biometric-login指纹登录">API GET /biometric-login 指纹登录</h3><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="250" src="attachments/6750224/6750232.png" data-image-src="http://confluence.txw.com:9090/download/attachments/6750224/image2023-10-7_20-41-20.png?version=1&amp;modificationDate=1696682480000&amp;api=v2"></span></p><p>调用<strong>IAccessCodeLoginService</strong>的具体实现类的<strong>loginLoadParameter</strong>()方法，获得<strong>Random Id</strong>和<strong>Random Num</strong>。</p><p>调用<strong>CryptoClientService</strong>类的<strong>storeRandomNumber</strong>()方法，为了后续验证。</p><p>TansactionSequenceNumber和ResponseCode。</p><p>其他参数包括modulusString模数，exponent指数，minLength，maxLength，maxLoginIdLength通过配置文件获取。这些参数是Region、API level。</p><p>比如setPassword、preLoginLoadParam、accesscodeLogin、biometricLogin、biometricRegistration。</p><p><a href="https://www.52dianzi.com/category/article/37/447209.html" class="external-link" rel="nofollow">从模数和指数生成 RSA 公钥</a></p><p><span style="color: rgb(0,0,0);">PublicKey publicKey = KeyFactory.getInstance(&quot;RSA&quot;).generatePublic(new RSAPublicKeySpec(modulus, exponent));</span></p><p><br/></p><h3 id="ms-customer-security-APIPOST/biometric-login指纹登录">API POST /biometric-login 指纹登录</h3><h4 id="ms-customer-security-流程："><strong>流程</strong>：</h4><p>校验Pin。</p><p>调用EBS和cust-profile，校验用户状态。</p><p>同步用户状态，INB和MS。</p><p>对shadow mode login，调用UAS/v1/VerifyOTP。</p><p>创建IdToken。</p><p>AFMS校验。</p><p>FMS校验。</p><p>调用ms-auth创建x-acc-op。</p><p>校验Routing indicator，返回smsRegistered flag。</p><p>更新IdToken，如果indicator是security check required。</p><p>调用USP更新INB，用户成功登录的信息。</p><p>更新usr_auth表和usr_reg表。</p><p>更新user.cifNo，调用USP更新INB。</p><p>调用USP更新INB，disable session。</p><p>把调用EBS的结果放入缓存。</p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><h3 id="ms-customer-security-API/biometric-login/register">API /biometric-login/register</h3><h3 id="ms-customer-security-API/biometric-login/deregister">API /biometric-login/deregister</h3><h3 id="ms-customer-security-API/ndi/biometric-login/{action}">API /ndi/biometric-login/{action}</h3><p>disable、enable、解锁卡。</p><h3 id="ms-customer-security-API/pre-login/parameterGET"><span style="color: rgb(0,0,0);">API /pre-login/parameter GET </span></h3><p><span style="color: rgb(0,0,0);">获取调用Pre Login接口所需参数，包括modulusString、exponent、minLength、maxLength、maxLoginIdLength、randomNumber、randomID、transactionSequenceNumber、responseCode。</span></p><p><span style="color: rgb(0,0,0);">V2 MY，通过调用SOA <strong>CBS-GetRandomNumber-I</strong>，获取randomID和randomNumber，其他参数从配置文件获得。</span></p><p><span style="color: rgb(0,0,0);">V1 SG，</span></p><p><span style="color: rgb(0,0,0);">存储<span style="color: rgb(0,0,0);">randomID、</span><span style="color: rgb(0,0,0);">randomNumber、expiresAt到<strong>random_no_history</strong>表。</span></span></p><h3 id="ms-customer-security-API/pre-loginPOST注册/激活网上银行"><span style="color: rgb(0,0,0);">API /pre-login POST 注册/激活网上银行</span></h3><p>用户注册/激活网上银行。把用户信息存储到DB，包括用户的密码密文。</p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 151.0px;"/><col style="width: 552.0px;"/></colgroup><tbody><tr><th class="confluenceTh">请求参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">x-acc-jwt</td><td class="confluenceTd"><p>JWT包括cif_no、<strong>card_no</strong>、legal_id、id_type、id_country、login_id。</p><p>用户开卡是注册网上银行的前提。</p></td></tr><tr><td class="confluenceTd">x-acc-op</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">cString</td><td colspan="1" class="confluenceTd"><p>前端JS通过pin、newPin、randomNo、modulusString、exponent计算得到。</p><p>以上参数通过调用<strong>/pre-login/parameter GET</strong>获取。</p></td></tr><tr><td colspan="1" class="confluenceTd">pString</td><td colspan="1" class="confluenceTd">同上。</td></tr><tr><td colspan="1" class="confluenceTd">randomId</td><td colspan="1" class="confluenceTd"><span>通过调用/pre-login/parameter GET获取。</span></td></tr><tr><td colspan="1" class="confluenceTd">maskedPassword</td><td colspan="1" class="confluenceTd"><p>开卡成功后提供给用户的默认网上银行密码。</p><p>SG流程：将被存储到usr_auth表encry_pwd字段。</p></td></tr><tr><td colspan="1" class="confluenceTd">loginId</td><td colspan="1" class="confluenceTd"><p>如果为空，以JWT.loginId代替。</p><p>存储到usr表login_id字段。</p></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 115.0px;"/><col style="width: 553.0px;"/></colgroup><tbody><tr><th class="confluenceTh">响应参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">status</td><td class="confluenceTd">是否成功 OK</td></tr></tbody></table></div><h4 id="ms-customer-security-流程">流程</h4><p>1. 校验请求参数。</p><p>2. 如果是V2 MY，查询usr表，如果存在loginId则返回错误码。</p><p><br/></p><p><strong>如果是V2 MY</strong></p><p>3. 调用ms-crypto/internal/pin/create，创建密码。ms-crypto调用HSM（负责加解密），并把loginId/密码密文保存到本地。</p><p>调用EBS-PSCustLoginID-C，创建access code。</p><p><strong>如果是V1 SG</strong></p><p>3. 调用EBS-OnlineINBAccessCodeApp-CU，创建密码和access code。</p><p><br/></p><p>4. 异步调用ms-fraud-surveillance/fms/check，校验。</p><p>5. 在usr和usr_auth表中创建记录（pin/accessCode/cifNo），如果coexistence.write=ON，调用USP存储过程，同步到INB DB。</p><p>6. 异步调用ms-customer-profile/internal/user/create创建用户，retail_customer / CUSTOMER / CUSTOMER_CONTACT表。</p><p>7. 发送Kafka消息，给ms-audit和ms-customer-notification。</p><h3 id="ms-customer-security-API/pre-login/verifyPOST"><span style="color: rgb(0,0,0);">API /pre-login/verify POST</span></h3><p><span style="color: rgb(0,0,0);">在登录之前校验参数。可以在POST /pre-login之前调用。</span></p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 155.0px;"/><col style="width: 562.0px;"/></colgroup><tbody><tr><th class="confluenceTh">请求参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr></tbody></table></div><p><span style="color: rgb(0,0,0);"><br/></span></p><h3 id="ms-customer-security-API/accesscode-loginGET用户名登录，获取登录所需参数">API /accesscode-login GET 用户名登录，获取登录所需参数</h3><p>获取登录参数，<span style="color: rgb(0,0,0);">包括modulusString、<span style="color: rgb(0,0,0);">exponent、minLength、maxLength、maxLoginIdLength、randomNumber、randomID、transactionSequenceNumber（only SG）、responseCode<span style="color: rgb(0,0,0);">（only SG）</span></span></span>。</p><p>以上参数大多配置在配置文件中。前端获取到这些参数后，通过JS计算得到pString和cString，然后调用/accesscode-login POST接口。</p><h4 id="ms-customer-security-流程.1">流程</h4><p>1、调用ms-crypto，产生<span style="color: rgb(0,0,0);">randomID和</span>randomNumber，存储到RandomNumber表和缓存。</p><p>2、从配置文件中获取参数，<span style="color: rgb(0,0,0);">modulusString、</span><span style="color: rgb(0,0,0);">exponent等。</span></p><p>3、从缓存pinPolicyCache获取<span style="color: rgb(0,0,0);">modulusString、</span><span style="color: rgb(0,0,0);">exponent。</span></p><p><br/></p><h3 id="ms-customer-security-API/accesscode-loginPOST用户名登录">API /accesscode-login POST 用户名登录</h3><p>access code登录接口。</p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 193.0px;"/><col style="width: 660.0px;"/></colgroup><tbody><tr><th class="confluenceTh">请求参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">x-source-app</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">loginId</td><td class="confluenceTd">用户名</td></tr><tr><td colspan="1" class="confluenceTd">rid</td><td colspan="1" class="confluenceTd">在调用preLogin接口时创建并缓存。如果缓存没有则抛出异常ACL-5036</td></tr><tr><td colspan="1" class="confluenceTd">pString</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">cString</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">password</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">loginMode</td><td colspan="1" class="confluenceTd">INB, NETS, FPX, IPA, EGIRO, MBS, OPENBANKING_CONSENT, ONBOARDING, ACCT_OPENING_CORP</td></tr><tr><td colspan="1" class="confluenceTd">transactionContextId</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">afmsSessionId</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">authorizationId</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">transactionType</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">captchaToken</td><td colspan="1" class="confluenceTd">JSONObject，验证码</td></tr><tr><td colspan="1" class="confluenceTd"><span>captchaToken-&gt;captchaId</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span>captchaToken-&gt;value</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">deviceInfo</td><td colspan="1" class="confluenceTd"><span>JSONObject，设备信息</span></td></tr><tr><td colspan="1" class="confluenceTd"><span>deviceInfo-&gt;fpt</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span>deviceInfo-&gt;tid</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span>deviceInfo-&gt;tsn</span></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd"><span>deviceInfo-&gt;device</span></td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 153.0px;"/><col style="width: 464.0px;"/></colgroup><tbody><tr><th class="confluenceTh">响应参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">referenceNo</td><td class="confluenceTd">格式：yyyyMMdd+6 random num</td></tr><tr><td colspan="1" class="confluenceTd">trxDateTime</td><td colspan="1" class="confluenceTd">2025-03-10</td></tr><tr><td colspan="1" class="confluenceTd">routeIndicator</td><td colspan="1" class="confluenceTd"><p>导航码</p><p>0 LOGIN</p><p>1 SUCCESS</p><p>3 TERMS</p><p>7 HWK_NEW_TOKEN_REQUEST</p><p>8 NEW_TOKEN_BIND</p><p>9 LOGIN_OTP</p><p>15 FORCE_CHANGE_PIN</p><p>16 REQUIRE_CAPTCHA</p><p>17 ELEVATE</p><p>18 SMS_TOKEN_ACTIVATION</p><p>19 TOKEN_PREFERENCE</p><p>20 REQUIRE_SECURITY_IMAGE</p><p>21 SOFTTOKEN_INTRO</p><p>23 <span>SOFTTOKEN_SUBSEQ_ACTIVATION</span></p><p><span>24 <span>SOFTTOKEN_NEW_TO_BANK_ACTIVATION</span></span></p><p><span><span>25 <span>SOFTTOKEN_SHADOW_ACTIVATION</span></span></span></p><p><span><span><span>26 <span>SOFTTOKEN_AUTO_PROVISION</span></span></span></span></p><p><span><span><span><span>31 FUID_SETUP</span></span></span></span></p><p><span><span><span><span>FAIL FAIL</span></span></span></span></p></td></tr><tr><td colspan="1" class="confluenceTd">securityImage</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">securityPhrase</td><td class="confluenceTd"><br/></td></tr></tbody></table></div><p>调用<strong>IAccessCodeLoginService</strong>的具体实现类的<strong>accessCodeLogin</strong>()方法，下面以AccessCodeLoginSoaServiceImpl类为例。</p><h4 id="ms-customer-security-1.校验请求信息checksecurityimage。">1. 校验请求信息check security image。</h4><p>如果PString，CString和password为空，则查询<strong>Usr</strong>表获取sec_img_cd，通过<strong>SecurityImgPhraseCommonService</strong>类调用<strong>ms-reference-data</strong>接口，获取securityImage和securityPhrase，同时返回200，且routingIndicator=20。</p><h5 id="ms-customer-security-1.1校验验证码Captcha">1.1 校验验证码Captcha</h5><p>通过调用ms-captcha服务的/captcha/validate接口进行校验。</p><h5 id="ms-customer-security-1.2校验请求参数">1.2 校验请求参数</h5><p>通过AccessCodeLoginCommonServiceImpl类的validateMandatoryAccessCodeLoginRequest()方法。</p><h4 id="ms-customer-security-2.登录流程">2. 登录流程</h4><p>校验账户的状态。</p><p><br/></p><p>发送kafka</p><p>返回响应头，包括x-acc-op，x-ref-op等。</p><p>返回响应体，包括reference no，trx datetime，<strong>route indicator</strong>，expire in。</p><p><br/></p><h4 id="ms-customer-security-流程：.1">流程：</h4><p>获取resourceId。</p><p>通过工具类创建trxRefNo。</p><p>校验是否IPA flow。</p><p><strong>如果request.txnId为空</strong></p><p>校验loginId。</p><p>如果是IPA flow，通过loginId，调用USP查询INB old DB。</p><p>否则先查本地usr表，如果记录为空再查INB old DB。</p><p>调用ms-crypto返回<span style="color: rgb(0,0,0);">randomID和</span>randomNumber，存储到RandomNumber表和缓存。</p><p>存储到usr_authorization表。</p><p><br/></p><p><strong>如果request.txnId不为空</strong></p><p>1. 校验prelogin和randomID。</p><p><span style="color: rgb(0,0,0);">注：什么是prelogin？用户注册网上银行。</span></p><p>2. 校验安全图片<span style="color: rgb(6,7,31);">Security image</span>。</p><p>注：<span style="color: rgb(6,7,31);">Security image安全图片是在用户注册时由用户从系统预设的图片库中选择的一张图片，并附上用户自己设定的注释。在每次登录时，系统会显示这张图片和注释，作为用户验证身份的一种方式。其主要目的是增加一层额外的安全验证，以防止钓鱼网站和其他形式的网络攻击。</span></p><p>3. 校验验证码Captcha，调用ms-captcha。</p><p>4. 校验pString，cString，password，rId。</p><p>5. <span style="color: rgb(255,0,0);">登录流程</span>，返回Routing Indicator路由码。</p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">注：什么是pString，cString？前端JS通过pin、newPin、randomNo、modulusString、exponent计算得到的字符串。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">6. <span style="color: rgb(0,0,0);">校验用户账号状态，比如是否被锁</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">调用ms-accounts/查询inb db。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">7. <span style="color: rgb(0,0,0);">校验loginId/密码密文</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">调用ms-crypto/internal/pin/verify。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">8. 本地生成JWT。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">9. <span style="color: rgb(0,0,0);">获取用户各种账号信息</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">调用ms-accounts/internal/all-account，比如casa、card、loan等。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">10. <span style="color: rgb(0,0,0);">失效INB DB的用户session</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">异步通过调用INB USP。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">11. <span style="color: rgb(0,0,0);">撤销用户token，</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">异步调用ms-auth/token/revoke。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">12. <span style="color: rgb(0,0,0);">校验FMS</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">异步调用ms-fraud-surveillance/internal/fms/check。</span></span></p><p><span style="color: rgb(0,0,0);">13. <span style="color: rgb(0,0,0);">校验AFMS</span></span></p><p><span style="color: rgb(0,0,0);">异步调用ms-fraud-management/v4/risk-score/retrieve，存储到缓存。</span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">14. <span style="color: rgb(0,0,0);">创建用户token</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">调用</span><span style="color: rgb(0,0,0);">ms-auth/athorization/secure-token，获取一对短token并返回。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);"><br/></span></span></p><p><br/></p><h3 id="ms-customer-security-API/accesscode-login/change-passwordGETaccesscodelogin修改密码">API /accesscode-login/change-password GET accesscode login修改密码</h3><p>获取参数。</p><h3 id="ms-customer-security-API/accesscode-login/change-passwordPOSTaccesscodelogin修改密码">API /accesscode-login/change-password POST accesscode login修改密码</h3><p>修改密码。</p><h3 id="ms-customer-security-API/accesscode-login/changeGETaccesscodelogin修改loginID">API /accesscode-login/change GET accesscode login修改loginID</h3><p>获取参数。</p><h3 id="ms-customer-security-API/accesscode-login/changePOSTaccesscodelogin修改loginID">API /accesscode-login/change POST accesscode login修改loginID</h3><p>修改loginID。</p><p><br/></p><h3 id="ms-customer-security-API/accesscode-login/accesscode/changePOST修改accesscode">API /accesscode-login/accesscode/change POST 修改accesscode</h3><p><span style="color: rgb(255,0,0);">TBC=====================</span></p><p><br/></p><h3 id="ms-customer-security-API/accesscode-elevation/elevatePOST">API /accesscode-elevation/elevate POST</h3><p>校验pin。</p><h3 id="ms-customer-security-API/singpass-loginPOSTSingpass登录">API /singpass-login POST Singpass登录</h3><h4 id="ms-customer-security-流程：.2">流程：</h4><p>1. 生成随机码referenceNo。</p><p>2. 校验nonce和singpass。</p><p>调用singpass.gov.sg/token，校验clientID，ecSignKey，aliasSignPrivatekey，codeVerifier</p><p>3. 检查loginMode。</p><p>如果不在配置名单NETS，FPX，OPENBANKING_CONSENT，EGIRO，IPA，返回null。</p><p>4. 校验partner Auth。</p><p>从缓存获取partnerAuthPolicy，通过policyCode，authType。</p><p>5. 获取loginId/cifno/accessCode</p><p>调用customer-profile/cif/inquiry → SOA EBS-CheckDuplicateCIF-I。</p><p>6. 校验account 状态</p><p>通过accessCode查询ms DB或INB USP。</p><p>如果用户不存在本地DB，查询INB。</p><p>7. 校验用户状态，调用EBS</p><p>获取用户mobileNo，调用customer-profile？</p><p>8. 更新用户信息和状态到INB DB</p><p>9. 如果用户本地不存在，但是INB存在，则本地新建用户</p><p>10. 如果是shadow mode登录，异步调用UAS，校验OTP，<span style="color: rgb(255,0,0);">OTP在请求体吗？</span></p><p>11. 创建custom JWT</p><p>12. 更新cifno，在本地DB和INB</p><p>13. 校验AFMS。</p><p>14. 创建token</p><p>调用ms-auth/authorization/secure-token</p><p>15. 把JWT放到请求头x-acc-jwt</p><p>16. 校验FMS，调用ms-fraud-surveillance/internal/fms/check</p><p>17. 检查routingIndicator</p><p>18. 校验first time singpass login</p><p>19. 失效INB session</p><p><br/></p><p><span style="color: rgb(255,0,0);">TBC=====================</span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,0,0);">调用Singpass，生成并返回<span style="color: rgb(0,0,0);">JWT</span>。</span></span></p><p><span style="color: rgb(0,0,0);">校验JWT.AUD和clientID是否匹配。</span></p><p><span style="color: rgb(0,0,0);"><br/></span></p><h3 id="ms-customer-security-API/tnc/update">API /tnc/update</h3><p>tnc: terms AND conditions 条件和条款。</p><p>询问用户是否接受tnc。如果接受则继续，否则返回错误并终止。</p><h3 id="ms-customer-security-APIGET/user-info">API GET /user-info</h3><p>获取用户JWT信息，返回JSON字符串。</p><h3 id="ms-customer-security-APIPOST/user/retrieve">API POST /user/retrieve</h3><p>查询用户登录loginID。</p><p>如果txnID不为空，调用cust-auth查询状态。</p><p>如果txnID为空或者状态为Failed，调用cust-auth TAC流程。</p><p>或者查询INB DB，如果loginID不为空，返回。如果为空，通过JWT的login_id，org_id，access_code字段，查询usr表。</p><h3 id="ms-customer-security-API/user-management/access">API /user-management/access</h3><p>一键禁用用户session和互联网访问权限（比如mobile、INB），实现KILL SWITCH。</p><h3 id="ms-customer-security-API/logout登出">API /logout 登出</h3><p><br/></p><h3 id="ms-customer-security-APItrouble-login/initPOST">API trouble-login/init POST</h3><p>用户在登录/重置PIN过程中如果遇到问题，身份验证流程，通过调用ms-identity-assurance POST v1/internal/id-verification/init 触发用户ID验证。</p><h3 id="ms-customer-security-APItrouble-login/retrievePOST">API trouble-login/retrieve POST</h3><p>通过调用ms-identity-assurance POST v1/internal/id-verification/submit获取用户identity token，通过identity token获取FUID。</p><h3 id="ms-customer-security-APItrouble-login/submitPOST">API trouble-login/submit POST</h3><p>身份验证流程的最终提交。</p><h2 id="ms-customer-security-主要业务流程">主要业务流程</h2><h2 id="ms-customer-security-主要架构设计方案">主要架构设计方案</h2><h2 id="ms-customer-security-主要数据库设计">主要数据库设计</h2><h3 id="ms-customer-security-usr用户表">usr用户表</h3><div class="table-wrap"><table class="relative-table confluenceTable" style="width: 32.1703%;"><colgroup><col style="width: 28.7011%;"/><col style="width: 71.3261%;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th></tr><tr><td class="confluenceTd">id</td><td class="confluenceTd">UUID</td></tr><tr><td class="confluenceTd">usr_status_code</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">usr_status_mod_code</td><td class="confluenceTd">modify</td></tr><tr><td class="confluenceTd">usr_status_mod_remarks</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">login_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">login_group_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">access_code</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">cif_no</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">first_login_tim</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">last_success_login_time</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">last_invalid_login_time</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">login_invalid_ct</td><td colspan="1" class="confluenceTd">count</td></tr><tr><td colspan="1" class="confluenceTd">login_success_-ct</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">last_tnc_accept</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">sec_img_cd</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">sec_phrase</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">auth_group</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">is_first_singpass_login</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">captcha_invalid_ct</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">attribute</td><td colspan="1" class="confluenceTd">JSONB</td></tr><tr><td colspan="1" class="confluenceTd">is_migrated</td><td colspan="1" class="confluenceTd">inbProfileMigrated</td></tr></tbody></table></div><h3 id="ms-customer-security-usr_auth用户登录表">usr_auth 用户登录表</h3><div class="table-wrap"><table class="relative-table confluenceTable" style="width: 39.2882%;"><colgroup><col style="width: 30.4315%;"/><col style="width: 69.5885%;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th></tr><tr><td class="confluenceTd">id</td><td class="confluenceTd">UUID</td></tr><tr><td class="confluenceTd">auth_type</td><td class="confluenceTd"><span>登录类型，比如pwd，pwdv2, local_bio, signpass</span></td></tr><tr><td class="confluenceTd">login_group_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">login_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">encry_pwd</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">algo</td><td class="confluenceTd">算法类型，比如EBS，HSM，SSO</td></tr><tr><td class="confluenceTd">last_pwd_mod_time</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">auth_json</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">usr_reg_id</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">source_app</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">usr_id</td><td colspan="1" class="confluenceTd">UUID</td></tr></tbody></table></div><h3 id="ms-customer-security-usr_reg用户注册表">usr_reg 用户注册表</h3><div class="table-wrap"><table class="relative-table confluenceTable" style="width: 32.3098%;"><colgroup><col style="width: 36.1553%;"/><col style="width: 63.8718%;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th></tr><tr><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h3 id="ms-customer-security-usr_authorization">usr_authorization</h3><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 131.0px;"/><col style="width: 332.0px;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th></tr><tr><td class="confluenceTd">authorization_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">session_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">usr_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">detail</td><td class="confluenceTd">Object, JSONB</td></tr><tr><td colspan="1" class="confluenceTd">trx_type</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h2 id="ms-customer-security-遇到的问题和解决方案">遇到的问题和解决方案</h2><h2 id="ms-customer-security-优缺点和改进方案分析，业界对比">优缺点和改进方案分析，业界对比</h2><p>有重复代码，重复调用inb usp。</p><p><br/></p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/6750224/6750232.png">image2023-10-7_20-41-20.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 六月 14, 2025 21:40</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
