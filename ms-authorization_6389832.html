<!DOCTYPE html>
<html>
    <head>
        <title>专业剑 : ms-authorization</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">专业剑</a></span>
                            </li>
                                                    <li>
                                <span><a href="Base-Services_6389781.html">Base Services</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            专业剑 : ms-authorization
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> admin</span>, last modified on 三月 07, 2025
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1749908443776 {padding: 0px;}
div.rbtoc1749908443776 ul {list-style: disc;margin-left: 0px;}
div.rbtoc1749908443776 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1749908443776'>
<ul class='toc-indentation'>
<li><a href='#ms-authorization-服务描述'>服务描述</a></li>
<li><a href='#ms-authorization-主要API'>主要API</a>
<ul class='toc-indentation'>
<li><a href='#ms-authorization-/authorization/token/introspect校验短token的有效性'>/authorization/token/introspect 校验短token的有效性</a>
<ul class='toc-indentation'>
<li><a href='#ms-authorization-流程'>流程</a></li>
</ul>
</li>
<li><a href='#ms-authorization-API/authorization/token创建token'>API /authorization/token 创建token</a>
<ul class='toc-indentation'>
<li><a href='#ms-authorization-authorization_code'>authorization_code</a></li>
<li><a href='#ms-authorization-refresh_token'>refresh_token</a></li>
<li><a href='#ms-authorization-token_exchange'>token_exchange</a></li>
<li><a href='#ms-authorization-resource_owner'>resource_owner</a></li>
</ul>
</li>
<li><a href='#ms-authorization-API/authorization/token/revoke撤销指定的token'>API /authorization/token/revoke 撤销指定的token</a></li>
<li><a href='#ms-authorization-API/internal/token/revoke撤销指定用户的token'>API /internal/token/revoke 撤销指定用户的token</a></li>
<li><a href='#ms-authorization-API/authorization/token/identity查询idtoken'>API /authorization/token/identity 查询id token</a></li>
<li><a href='#ms-authorization-API/authorization/secure-token创建securetoken'>API /authorization/secure-token 创建secure token</a></li>
<li><a href='#ms-authorization-API/internal/token/update更新JWT参数'>API /internal/token/update 更新JWT参数</a></li>
<li><a href='#ms-authorization-API/authorization/validate校验token？'>API /authorization/validate 校验token？</a></li>
<li><a href='#ms-authorization-API/authorization/authorize创建授权码或token'>API /authorization/authorize 创建授权码或token</a></li>
<li><a href='#ms-authorization-API/authorization/authorize/authcode-info获取JWT详细信息'>API /authorization/authorize/authcode-info 获取JWT详细信息</a></li>
<li><a href='#ms-authorization-API/authorization/register注册client'>API /authorization/register 注册client</a></li>
<li><a href='#ms-authorization-API/authorization/unregister注销client？'>API /authorization/unregister 注销client？</a></li>
<li><a href='#ms-authorization-API/authorization/.well-know/jwks.json获取公钥'>API /authorization/.well-know/jwks.json 获取公钥</a></li>
</ul>
</li>
<li><a href='#ms-authorization-主要业务流程'>主要业务流程</a></li>
<li><a href='#ms-authorization-主要架构设计方案'>主要架构设计方案</a></li>
<li><a href='#ms-authorization-主要数据库设计'>主要数据库设计</a>
<ul class='toc-indentation'>
<li><a href='#ms-authorization-token'>token</a></li>
<li><a href='#ms-authorization-token_policy'>token_policy</a></li>
<li><a href='#ms-authorization-AuthCode'>AuthCode</a></li>
<li><a href='#ms-authorization-Client'>Client</a></li>
<li><a href='#ms-authorization-DeviceInfo'>DeviceInfo</a></li>
</ul>
</li>
<li><a href='#ms-authorization-遇到的问题和解决方案'>遇到的问题和解决方案</a></li>
<li><a href='#ms-authorization-优缺点和改进方案分析，业界对比'>优缺点和改进方案分析，业界对比</a></li>
</ul>
</div></p><p><br/></p><p><strong>参考：</strong></p><p><a href="http://http//confluence.txw.com:9090/display/SPC/txw-auth" class="external-link" rel="nofollow">txw-auth - 专业剑</a></p><p><a href="http://confluence.txw.com:9090/display/SPC/JWT" rel="nofollow">JWT - 专业剑</a></p><p><a href="http://confluence.txw.com:9090/display/SPC/JWT#JWT-%E5%A6%82%E4%BD%95%E8%AF%84%E4%BB%B7OCBC%E7%9A%84token%E8%AE%A4%E8%AF%81%E6%96%B9%E6%A1%88" rel="nofollow">JWT - 专业剑 - 如何评价OCBC的token认证方案</a></p><h2 id="ms-authorization-服务描述">服务描述</h2><p>该服务主要负责鉴权token的管理，包括创建、续期、校验、撤销等。</p><p>因为所有的API的访问都需要通过gateway和token校验，所以该服务和接口的访问量非常大。</p><p>该服务采用了长短token的设计。</p><h2 id="ms-authorization-主要API">主要API</h2><p>包括token的创建/authorization/token、续期/authorization/token、撤销/authorization/token/revoke、校验/authorization/introspect。</p><h3 id="ms-authorization-/authorization/token/introspect校验短token的有效性">/authorization/token/introspect 校验短token的有效性</h3><p>根据请求参数的短token和token type hint，校验该短token是否有效。</p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 135.0px;"/><col style="width: 694.0px;"/></colgroup><tbody><tr><th class="confluenceTh">请求参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">token</td><td class="confluenceTd">短token</td></tr><tr><td class="confluenceTd">tokenTypeHint</td><td class="confluenceTd">枚举类型，token的类型，包括access_token，refresh_token</td></tr><tr><td class="confluenceTd">returnTokens</td><td class="confluenceTd">可以为空，或者是希望返回的token类型，包括<span>access_token，refresh_token，id_token</span></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 141.0px;"/><col style="width: 687.0px;"/></colgroup><tbody><tr><th class="confluenceTh">响应参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">active</td><td class="confluenceTd">短token的状态<span>是否有效</span></td></tr><tr><td class="confluenceTd"><span>token</span></td><td class="confluenceTd"><p>长token具体值。如果active=false，则为空。</p><p><span style="color: rgb(0,51,102);">如果tokenTypeHint有值，该字段才会返回对应该token type的token的值。</span></p></td></tr><tr><td class="confluenceTd">tokens</td><td class="confluenceTd"><p>长token的具体信息，<span>IntrospectSubResponse</span>对象列表类型，包括以下字段。</p><p>type 类型，包括<span>access_token，refresh_token，id_token</span></p><p>active，是否有效</p><p>token，长token的具体值</p><p>updatedTime，最后更新时间</p><p>reason，如果无效的原因，1-Revoked已撤销，2-Duplicate重复，3-Refreshed已刷新</p></td></tr><tr><td colspan="1" class="confluenceTd">isRefreshable</td><td colspan="1" class="confluenceTd">该token是否可以刷新</td></tr></tbody></table></div><h4 id="ms-authorization-流程">流程</h4><p>如果tokenTypeHint为空，通过opToken，查询token表的有效记录。如果返回记录不为空，获取userTokenSession对象。</p><p>如果tokenTypeHint不为空，通过opToken和tokenTypeHint，查询内存userTokenSessionCache。</p><p>如果得到的userTokenSession对象为空，表示没有有效token。</p><p>通过opToken，查询token表的已删除记录，包括原因reason字段。</p><p>查询内存userTokenSession。</p><h3 id="ms-authorization-API/authorization/token创建token">API /authorization/token 创建token</h3><p>根据请求参数的<strong>grant type</strong>（authorization_code, refresh_token, token_exchange, resource_owner），生成并返回token。</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="400" src="attachments/6389832/6389847.png" data-image-src="http://confluence.txw.com:9090/download/attachments/6389832/image2023-10-1_22-46-23.png?version=1&amp;modificationDate=1696171583000&amp;api=v2"></span></p><p>通过调用<strong>TokenCreator</strong>类的<strong>generate</strong>()方法创建token。</p><p>该方法调用<strong>JWTEncryptionService</strong>类的<strong>getRsaKey</strong>()方法获取RSAKey，<strong>getAuthPrivateKey</strong>()方法获取PrivateKey，再调用<strong>SignedJWT</strong>类的<strong>sign</strong>()方法创建token，包括<strong>access token</strong>和<strong>refresh token</strong>。</p><p>该方法通过调用<strong>JwtTokenUtil</strong>类的<strong>generateOpaqueToken</strong>()方法产生<strong>opaque token</strong>，实际是通过<strong>SecureRandom</strong>工具类产生随机字符串。</p><p>根据<strong>opaque token，</strong><strong>access token</strong>和<strong>refresh token，创建UserTokenSession。</strong></p><p>更新<strong>token表。</strong></p><p>更新redis缓存。</p><h4 id="ms-authorization-authorization_code"><strong>authorization_code</strong></h4><p><strong>场景</strong>：mobile端是API Key的拥有者，web端是资源请求者。</p><p>1. 先通过mobile端调用ms-auth/authorization/authorize接口，传参API Key，获得auth code。</p><p>2. mobile端传递auth code给web端。</p><p>3. web端调用ms-auth/authorization/token接口，传参auth code，获得一对短token（op-acc-token和op-ref-token）。</p><p><br/></p><p>通过查询缓存或者auth_code表，获取可用auth code，设置状态为删除并更新表，返回auth code session。</p><p><br/></p><p>校验auth code是否可用</p><p>如果是同组则撤销token</p><p>失效当前auth code</p><p>创建新token记录</p><p><br/></p><h4 id="ms-authorization-refresh_token"><strong>refresh_token</strong></h4><p><strong>场景：</strong>token续期。</p><p>请求传参一对当前短token（op-acc-token和op-ref-token），响应返回一对新的短token（op-acc-token和op-ref-token）</p><p><span style="color: rgb(255,0,0);">和/token/refresh接口什么区别？</span></p><p>校验当前token是否有效。撤销旧token。产生新token。包括以下步骤。</p><p>通过查询缓存或者token表，返回userTokenSession。</p><p>通过查询token_policy表，设置userTokenSession。</p><p>根据policy，刷新token。</p><p>撤销旧token，<strong>sts_cd='D'，reason=<strong>3 - Refresh</strong>，ver_nbr+1</strong>。产生新token。</p><p><br/></p><h4 id="ms-authorization-token_exchange"><strong>token_exchange</strong></h4><p><strong>场景：</strong>第三方登录。</p><p>1. mobile端调用SingPass登录，SingPass校验用户名密码，返回SingPass JWT。</p><p>2. mobile端调用ms-authorization，传参SingPass JWT。</p><p>3. ms-authorization使用SingPass公钥，校验SingPass JWT，返回短token。</p><p><br/></p><p><span style="color: rgb(255,0,0);">ms-customer-security/SingPass/login接口的作用？</span></p><p>3. ms-customer-security调用SingPass接口，传参授权码。SingPass校验成功。</p><p>4. ms-customer-security调用ms-auth/token接口，生成token并返回。</p><p><br/></p><h4 id="ms-authorization-resource_owner"><strong>resource_owner</strong></h4><p><strong>场景</strong>：最常见用法。</p><p>比如在登录成功后，调用ms-auth/token接口，传参API Key，获得一对短token（op-acc-token和op-ref-token）。</p><p><span style="color: rgb(255,0,0);">和authorization/authorize接口，传参<strong>request.responseType = RESOURCE_OWNER，有什么区别？<span style="color: rgb(0,51,102);">看起来一样。</span></strong></span></p><p><br/></p><h3 id="ms-authorization-API/authorization/token/revoke撤销指定的token">API /authorization/token/revoke 撤销指定的token</h3><p>根据请求参数（token，tokenTypeHint，Reason），撤销token，更新token表和缓存。</p><p>tokenTypeHint，token类型包括op_acc_token，op_ref_token。</p><p>Reason包括1-REVOKED，2-DUPLICATED，3-REFRESHED。</p><p><span style="color: rgb(0,51,102);">更新原token记录（sts_cd='</span><span style="color: rgb(0,51,102);">D</span><span style="color: rgb(0,51,102);">'，<strong>reason=请求参数Reason</strong>，ver_nbr+1）。</span></p><h3 id="ms-authorization-API/internal/token/revoke撤销指定用户的token">API /internal/token/revoke 撤销指定用户的token</h3><p>revoke token based on user id and channel code.</p><p><strong>步骤</strong>：</p><p>通过user id和channel code，查询token表。</p><p>如果记录不为空，软删除token表原记录。<span style="color: rgb(0,51,102);">更新原token记录（sts_cd='<span style="color: rgb(0,51,102);">D</span>'，<strong>reason=1 - REVOKED</strong>，ver_nbr+1）。</span></p><p>删除缓存的原记录。</p><h3 id="ms-authorization-API/authorization/token/identity查询idtoken">API /authorization/token/identity 查询id token</h3><p>通过请求参数的有效access token，返回id token。</p><p>通过请求头中的op_acc_token，查询缓存和token表，返回id_token字段。</p><h3 id="ms-authorization-API/authorization/secure-token创建securetoken">API /authorization/secure-token 创建secure token</h3><p>用于信任方（比如INB）为第三方（比如Robo Adviser）创建secure token（OCBC id token）。包括以下步骤。</p><p>查询token_policy表，通过source id和group code。</p><p>根据policy，校验id token是否有效。根据id token产生sub/subType。如果是同组则撤销旧token，<strong>sts_cd='D'，reason=<strong>2 - DUPLICATED</strong>，ver_nbr+1</strong>。产生新的token。返回user token session。</p><p><br/></p><h3 id="ms-authorization-API/internal/token/update更新JWT参数">API /internal/token/update 更新JWT参数</h3><p>用于内部ms更新JWT内部的custom字段，包括amr，ial，custom，elevated_domain。</p><p>更新token表和缓存。</p><p>场景：用户登录成功后调用cust-auth/access-elevation/request和/validate，1FA升级到2FA，/validate成功后调用ms-auth/internal/token/update接口，更新JWT参数。</p><p><br/></p><p><strong><span style="color: rgb(0,51,102);">步骤：</span></strong></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,51,102);">校验请求头x-acc-op字段是否为空。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,51,102);">通过x-acc-op查询缓存或数据库，返回userTokenSession。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,51,102);">通过<span style="color: rgb(0,51,102);">userTokenSession.accessToken获取JWT.custom。</span></span></span></p><p><span style="color: rgb(0,51,102);">如果updateTokenRequest.mode是<strong>SECURITY_CHECK_COMPLETED</strong>，移除custom.securityCheck字段。</span></p><p><span style="color: rgb(0,51,102);">如果是<strong>ELEVATION_CHECK_COMPLETED</strong>，<span style="color: rgb(0,51,102);">移除custom.securityCheck字段，更新AMR、IAL、elevated_domain、device_info字段。</span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,51,102);"><span style="color: rgb(0,51,102);"><strong>软删除原token记录（<span style="color: rgb(0,51,102);">sts_cd='</span><span style="color: rgb(0,51,102);">D</span><span style="color: rgb(0,51,102);">'，reason=<strong>null</strong>，ver_nbr+1</span>）。</strong><br/></span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,51,102);"><span style="color: rgb(0,51,102);">创建新的token记录，并保存DB。</span></span></span></p><p><span style="color: rgb(255,0,0);"><span style="color: rgb(0,51,102);"><span style="color: rgb(0,51,102);">更新缓存。</span></span></span></p><h3 id="ms-authorization-API/authorization/validate校验token？">API /authorization/validate <span style="color: rgb(255,0,0);">校验token？</span></h3><p><span style="color: rgb(255,0,0);"><br/></span></p><h3 id="ms-authorization-API/authorization/authorize创建授权码或token">API /authorization/authorize <span style="color: rgb(0,51,102);">创建授权码或token</span></h3><p>根据responseType，创建并返回authCode或者token。</p><p>校验client id。</p><p>查询token_policy表。</p><p>更新auth_code表。更新缓存。</p><p><span style="color: rgb(0,51,102);"><strong>request.responseType = CODE / RESOURCE_OWNER 分别代表类型：授权码，资源拥有者。</strong></span></p><p><span style="color: rgb(255,0,0);"><strong>创建JWT的详细流程？</strong></span></p><p><span style="color: rgb(255,0,0);"><br/></span></p><div class="table-wrap"><table class="confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">请求参数</th><th class="confluenceTh">描述</th></tr><tr><td colspan="1" class="confluenceTd">API_KEY</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">response_type</td><td colspan="1" class="confluenceTd"><p><strong>CODE: Auth Code flow，创建并返回Auth code。</strong></p><p><strong>RESOURCE_OWNER: 相当于创建并返回新token。</strong></p><p><strong>code-jwt, extended auth code flow to return authCode by given opaque token</strong></p></td></tr><tr><td colspan="1" class="confluenceTd">client_id</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">login_type</td><td colspan="1" class="confluenceTd">LEGAL_ID, ACCESS_CODE, MOBILE_NO</td></tr><tr><td colspan="1" class="confluenceTd">login_hint</td><td colspan="1" class="confluenceTd">access code, cif no or uuid</td></tr><tr><td colspan="1" class="confluenceTd">custom</td><td colspan="1" class="confluenceTd">JSON, org_id, cif_id, legal_id, legal_type</td></tr></tbody></table></div><p><span style="color: rgb(255,0,0);"><br/></span></p><div class="table-wrap"><table class="confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">响应参数</th><th class="confluenceTh">描述</th></tr><tr><td class="confluenceTd">x-acc-op响应头</td><td class="confluenceTd">短token</td></tr><tr><td class="confluenceTd">x-ref-op<span>响应头</span></td><td class="confluenceTd"><p><span>短token</span></p></td></tr><tr><td colspan="1" class="confluenceTd">响应体</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">authCode</td><td colspan="1" class="confluenceTd">授权码，32位随机数字符串，第三方通过调用/token用来获得access token</td></tr><tr><td colspan="1" class="confluenceTd">state</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">tokenType</td><td class="confluenceTd"><p>常量Bearer</p></td></tr><tr><td class="confluenceTd">expiresIn</td><td class="confluenceTd">token存续期，秒</td></tr></tbody></table></div><p><br/></p><h3 id="ms-authorization-API/authorization/authorize/authcode-info获取JWT详细信息">API /authorization/authorize/authcode-info 获取JWT详细信息</h3><p>根据auth code获取JWT详细信息。</p><p>查询缓存或auth_code表。</p><h3 id="ms-authorization-API/authorization/register注册client">API /authorization/register 注册client</h3><p>通过请求参数和API key，user name，client type为依赖方注册。</p><p>在client表新增记录。</p><p>在token_policy表新增记录。</p><h3 id="ms-authorization-API/authorization/unregister注销client？">API /authorization/unregister <span style="color: rgb(255,0,0);">注销client？</span></h3><h3 id="ms-authorization-API/authorization/.well-know/jwks.json获取公钥">API /authorization/.well-know/jwks.json 获取公钥</h3><p>调用<strong style="letter-spacing: 0.0px;">JWTEncryptionService</strong>类的<strong style="letter-spacing: 0.0px;">getKid2PublicKeyMap</strong><strong>()</strong>方法获取RSAKey列表。</p><p>通过配置文件key-store，加载RSA key，包括private key和public key。</p><p><br/></p><h2 id="ms-authorization-主要业务流程">主要业务流程</h2><p><br/></p><h2 id="ms-authorization-主要架构设计方案">主要架构设计方案</h2><p><br/></p><h2 id="ms-authorization-主要数据库设计">主要数据库设计</h2><h3 id="ms-authorization-token">token</h3><p>token信息表，包括token取值，channel，group，用户ID，是否撤销，撤销原因。</p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 178.0px;"/><col style="width: 178.0px;"/><col style="width: 252.0px;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th><th class="confluenceTh">Value</th></tr><tr><td class="confluenceTd">id</td><td class="confluenceTd">id</td><td class="confluenceTd">UUID</td></tr><tr><td colspan="1" class="confluenceTd">opAccessToken</td><td colspan="1" class="confluenceTd">op_acc_token</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">accessToken</td><td colspan="1" class="confluenceTd">acc_token</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">opRefreshToken</td><td colspan="1" class="confluenceTd">op_ref_token</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">refreshToken</td><td colspan="1" class="confluenceTd">ref_token</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">idToken</td><td colspan="1" class="confluenceTd">id_token</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">channelCode</td><td colspan="1" class="confluenceTd">chnl_cd</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">customerId</td><td colspan="1" class="confluenceTd">customer_Id</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">groupCode</td><td colspan="1" class="confluenceTd">grp_cd</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">revoked</td><td colspan="1" class="confluenceTd"><span>revoked</span></td><td colspan="1" class="confluenceTd">boolean</td></tr><tr><td colspan="1" class="confluenceTd">expiresAt</td><td colspan="1" class="confluenceTd">exp_time</td><td colspan="1" class="confluenceTd">ZoneDateTime</td></tr><tr><td colspan="1" class="confluenceTd">sub</td><td colspan="1" class="confluenceTd">sub</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">subType</td><td colspan="1" class="confluenceTd">sub_type</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">reason</td><td colspan="1" class="confluenceTd"><span>reason</span></td><td colspan="1" class="confluenceTd">Integer</td></tr></tbody></table></div><p><br/></p><h3 id="ms-authorization-token_policy">token_policy</h3><p>token配置表，配置token的过期时间的配置。flyway脚本最常见的操作：新建和更新token_policy表。</p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 175.0px;"/><col style="width: 179.0px;"/><col style="width: 253.0px;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th><th class="confluenceTh">Value</th></tr><tr><td class="confluenceTd">id</td><td class="confluenceTd">id</td><td class="confluenceTd">UUID</td></tr><tr><td class="confluenceTd"><p>grp_cd</p></td><td class="confluenceTd">group code</td><td class="confluenceTd">LLMS</td></tr><tr><td class="confluenceTd"><span>chnl_cd</span></td><td class="confluenceTd">channel code</td><td class="confluenceTd">LLMS</td></tr><tr><td class="confluenceTd"><span>auth_cd_exp_sec</span></td><td class="confluenceTd">auth code expiry</td><td class="confluenceTd">30</td></tr><tr><td class="confluenceTd">id_token_exp_sec</td><td class="confluenceTd">id token expiry</td><td class="confluenceTd">600 - <span>10 min</span></td></tr><tr><td class="confluenceTd">acc_token_exp_sec</td><td class="confluenceTd">access <span>token expiry</span></td><td class="confluenceTd">600 - <span>10 min</span></td></tr><tr><td class="confluenceTd">ref_token_exp_sec</td><td class="confluenceTd">refresh <span>token expiry</span></td><td class="confluenceTd">900 - <span>15 min</span></td></tr><tr><td colspan="1" class="confluenceTd">max_ref_exp_sec</td><td colspan="1" class="confluenceTd">max refresh <span>token expiry</span></td><td colspan="1" class="confluenceTd">5940 - <span>99 min</span></td></tr><tr><td colspan="1" class="confluenceTd">ver_nbr</td><td colspan="1" class="confluenceTd">version</td><td colspan="1" class="confluenceTd">0</td></tr><tr><td colspan="1" class="confluenceTd">sts_cd</td><td colspan="1" class="confluenceTd">status code</td><td colspan="1" class="confluenceTd">A</td></tr></tbody></table></div><p class="auto-cursor-target">grp_cd + chnl_cd 唯一主键。</p><p><br/></p><h3 id="ms-authorization-AuthCode">AuthCode</h3><p>授权码</p><div class="table-wrap"><table class="relative-table confluenceTable" style="width: 42.7076%;"><colgroup><col style="width: 28.973%;"/><col style="width: 29.1367%;"/><col style="width: 41.9088%;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th><th class="confluenceTh">Value</th></tr><tr><td class="confluenceTd">id</td><td class="confluenceTd">id</td><td class="confluenceTd">UUID</td></tr><tr><td class="confluenceTd">groupCode</td><td class="confluenceTd">grp_cd</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">channelCode</td><td class="confluenceTd">chnl_cd</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">clientId</td><td class="confluenceTd">client_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">customerId</td><td class="confluenceTd">customer_id</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">code</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">authStartTime</td><td class="confluenceTd">auth_start_time</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">nonce</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">loginHint</td><td class="confluenceTd">login_hint</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">loginType</td><td class="confluenceTd">login_type</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">scope</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">custom</td><td colspan="1" class="confluenceTd"><span>custom</span></td><td colspan="1" class="confluenceTd">jsonb</td></tr><tr><td colspan="1" class="confluenceTd">amr</td><td colspan="1" class="confluenceTd"><span>amr</span></td><td colspan="1" class="confluenceTd"><span>jsonb</span></td></tr><tr><td colspan="1" class="confluenceTd">scopes</td><td colspan="1" class="confluenceTd"><span>scopes</span></td><td colspan="1" class="confluenceTd"><span>jsonb</span></td></tr><tr><td colspan="1" class="confluenceTd">ial</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">redirectUrl</td><td colspan="1" class="confluenceTd">redirect_url</td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">state</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">expiresAt</td><td colspan="1" class="confluenceTd">exp_time</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h3 id="ms-authorization-Client">Client</h3><p>注册ClientID，ClientType。</p><div class="table-wrap"><table class="fixed-table confluenceTable"><colgroup><col style="width: 177.0px;"/><col style="width: 179.0px;"/><col style="width: 262.0px;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th><th class="confluenceTh">Value</th></tr><tr><td class="confluenceTd">id</td><td class="confluenceTd">id</td><td class="confluenceTd">UUID</td></tr><tr><td class="confluenceTd">clientName</td><td class="confluenceTd">client_name</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">clientType</td><td class="confluenceTd">client_type</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">clientSecret</td><td class="confluenceTd">client_secret</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">grantType</td><td class="confluenceTd">grant_type</td><td class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">scope</td><td colspan="1" class="confluenceTd"><br/></td><td colspan="1" class="confluenceTd"><br/></td></tr><tr><td colspan="1" class="confluenceTd">redirectUrl</td><td colspan="1" class="confluenceTd">redirect_url</td><td colspan="1" class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h3 id="ms-authorization-DeviceInfo">DeviceInfo</h3><p>不是表</p><div class="table-wrap"><table class="relative-table confluenceTable" style="width: 43.2659%;"><colgroup><col style="width: 28.437%;"/><col style="width: 29.2448%;"/><col style="width: 42.3364%;"/></colgroup><tbody><tr><th class="confluenceTh">Field</th><th class="confluenceTh">Remark</th><th class="confluenceTh">Value</th></tr><tr><td class="confluenceTd">fpt</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">tid</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">tsn</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">device</td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr></tbody></table></div><p><br/></p><h2 id="ms-authorization-遇到的问题和解决方案">遇到的问题和解决方案</h2><p><br/></p><h2 id="ms-authorization-优缺点和改进方案分析，业界对比">优缺点和改进方案分析，业界对比</h2><p>所有经过gateway的请求都需要调用ms-authorization，容易成为性能瓶颈。</p><p>日志太少。</p><p><br/></p><p><br/></p><p><br/></p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/6389832/6389843.png">image2023-10-1_22-18-23.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/6389832/6389844.png">image2023-10-1_22-28-53.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/6389832/6389847.png">image2023-10-1_22-46-23.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/6389832/6389854.png">C5B856E0-CEB6-466F-8A76-5BF898AA6C60.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 六月 14, 2025 21:40</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
